<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kotlin Compiler IR Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-graphviz/5.0.2/d3-graphviz.min.js"></script>
    <script src="visualizer.js"></script>
    <script src="helper.js"></script>
    <link rel="stylesheet" href="visualizer.css">
</head>
<body>
<div class="container">
    <div id="top">
        <h1>Kotlin Compiler IR Visualization</h1>
        <button id="open-filter" class="filter-button">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 2H1L7 9.5V14L9 15V9.5L15 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Filters
            <span id="filter-count" style="background: #ddd; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; justify-content: center; align-items: center; font-size: 12px;">0</span>
        </button>
        <button id="download-svg">Download SVG</button>
        <label for="disable-clustering">Disable Clustering:</label>
        <input type="checkbox" id="disable-clustering">
    </div>

    <div id="filter-popup" class="filter-popup">
        <h3>Filter Nodes</h3>
        <div class="filter-row">
            <select id="filter-type">
                <option value="NodeType">Node Type</option>
                <option value="Name">Name</option>
            </select>
            <input type="text" id="filter-value" placeholder="Filter value">
        </div>
        <div class="filter-buttons">
            <button id="add-filter">Add Filter</button>
        </div>
        <div class="active-filters">
            <div class="horizontal spacebetween">
                <h4>Active Filters</h4>
                <button id="clear-filters">Clear All</button>
            </div>
            <div id="active-filter-tags"></div>
        </div>
    </div>

    <div class="content-wrapper">
        <div id="graph-container" class="graph-container no-select"></div>
        <div id="leftCol" class="spacebetween vertical">
            <div id="selected-node-info">
                <h3>Click on any node to see details here</h3>
            </div>
            <button disabled="true" id="expandAllChildren">Expand All Children</button>
        </div>

    </div>
</div>

<script>
    const checkbox = document.getElementById('disable-clustering');
    const expandBtn = document.getElementById('expandAllChildren');


    const jsonString = getJSON();
    const obj = JSON.parse(jsonString);
    assignNodeIds(obj);
    const nodeDict = createNodeDict(obj);
    let dotSource = createDotSource(obj);


    // Global variable to store the graphviz instance
    let graphvizInstance;
    let selectedNodeId;

    const activeFilters = [];

    // Initialize the graphviz instance (call this once during setup)
    function initGraphviz() {
        const container = document.getElementById("graph-container");
        graphvizInstance = d3.select(container)
            .graphviz({useWorker: false})
            .width("100%")
            .height("100%")
            .fit(true)
            .zoom(true);

        // Initial rendering
        renderGraph(dotSource);
    }

    // Render graph initially
    function renderGraph(dotSource) {
        try {
            const container = document.getElementById("graph-container");

            // Render with graphviz
            graphvizInstance
                .transition(function () {
                    return d3.transition()
                        .duration(750)
                        .ease(d3.easeLinear);
                })
                .renderDot(dotSource)
                .on("end", function () {
                    // After rendering is complete
                    const svg = container.querySelector("svg");
                    svg.dataset.originalViewBox = svg.getAttribute("viewBox");

                    svg.addEventListener("contextmenu", function (event) {
                        //event.preventDefault();
                    });

                    addNodeClickHandlers(svg);

                    setUpDownloadButton(svg);

                    if (selectedNodeId) {
                        markSelected(svg, selectedNodeId);
                        selectedNodeGroup = getNodeByNodeId(selectedNodeId);
                        drawAllDottedLines(selectedNodeGroup)
                    }

                    d3.select(container).select("svg").on("dblclick.zoom", null);
                });
        } catch (error) {
            console.error(error);
            document.getElementById("graph-container").innerHTML =
                `<div style="color: red; padding: 20px;">
                Error rendering graph: ${error.message}
            </div>`;
        }
    }

    // Update the graph with a new dot source and animate the transition
    function updateGraph() {
        dotSource = createDotSource(obj);
        try {
            if (!graphvizInstance) {
                console.error("Graphviz instance not initialized. Call initGraphviz() first.");
                return;
            }


            removeAllDottedLines()

            // Configure the transition
            graphvizInstance
                .transition(function () {
                    return d3.transition()
                        .duration(750)  // Duration of transition in milliseconds
                        .ease(d3.easeLinear);
                })
                .tweenShapes(true)      // Enable shape tweening
                .tweenPaths(false)       // Enable path tweening
                .convertEqualSidedPolygons(true)  // Helps with smoother transitions
                .growEnteringEdges(true)  // Animate new edges growing
                .renderDot(dotSource);

        } catch (error) {
            console.error("Error updating graph:", error);
            document.getElementById("graph-container").innerHTML =
                `<div style="color: red; padding: 20px;">
                Error updating graph: ${error.message}
            </div>`;
        }
    }

    // Helper function to set up the download button
    function setUpDownloadButton(svg) {
        document.getElementById("download-svg").addEventListener("click", function () {
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "dot_graph.svg";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    function addNodeClickHandlers(svg) {
        const nodeGroups = svg.querySelectorAll(".node");
        nodeGroups.forEach(nodeGroup => {
            nodeGroup.style.cursor = "pointer";
            if (!nodeGroup.handlersAdded) {

                nodeGroup.addEventListener("mouseover", function () {
                    const shape = nodeGroup.querySelector("ellipse, polygon, path, rect");
                    if (shape) {
                        shape.setAttribute("stroke-width",
                            parseFloat(shape.getAttribute("stroke-width") || 1) + 1);
                    }
                });

                nodeGroup.addEventListener("mouseout", function () {
                    const shape = nodeGroup.querySelector("ellipse, polygon, path, rect");
                    if (shape) {
                        shape.setAttribute("stroke-width",
                            Math.max(1, parseFloat(shape.getAttribute("stroke-width") || 2) - 1));
                    }
                });

                nodeGroup.addEventListener("dblclick", function () {
                    const nodeId = nodeGroup.querySelector("title").textContent.trim();
                    const nodeData = nodeDict[nodeId];
                    toggleChildren(nodeData.original, hasInvisibleChild(nodeData.original))

                    updateGraph()
                });

                nodeGroup.addEventListener("click", function () {
                    expandBtn.disabled=false;

                    const nodeId = nodeGroup.querySelector("title").textContent.trim();

                    setInfoDiv(nodeGroup)

                    unmarkSelected(svg);
                    selectedNodeId = nodeId;
                    markSelected(svg, selectedNodeId);

                    removeAllDottedLines()
                    drawAllDottedLines(nodeGroup)
                });
                nodeGroup.handlersAdded = true;
            }

        });

    }


    checkbox.addEventListener('change', function (event) {
        updateGraph();
    });

    expandBtn.addEventListener('click', function (event) {
        expandAll(nodeDict[selectedNodeId].original);
        updateGraph();
    });

    const filterButton = document.getElementById('open-filter');
    const filterPopup = document.getElementById('filter-popup');
    const addFilterBtn = document.getElementById('add-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const filterType = document.getElementById('filter-type');
    const filterValue = document.getElementById('filter-value');
    const activeFilterTags = document.getElementById('active-filter-tags');
    const filterCount = document.getElementById('filter-count');

    filterButton.addEventListener('click', function() {
        if (filterPopup.style.display === 'block') {
            filterPopup.style.display = 'none';
        } else {
            filterPopup.style.display = 'block';
            const rect = filterButton.getBoundingClientRect();
            filterPopup.style.top = `${rect.bottom + 5}px`;
            filterPopup.style.left = `${rect.left}px`;
            filterValue.focus();
        }
    });

    document.addEventListener('click', function(event) {
        if (!filterPopup.contains(event.target) && event.target !== filterButton && event.target.className!=="filter-tag-close") {
            filterPopup.style.display = 'none';
        }
    });

    addFilterBtn.addEventListener('click', function() {
        if (filterValue.value.trim() === '') return;

        const filter = {
            type: filterType.value,
            value: filterValue.value.trim()
        };

        const existingFilter = activeFilters.find(f =>
            f.type === filter.type && f.value === filter.value
        );

        if (!existingFilter) {
            activeFilters.push(filter);
            updateFilterTags();
            filterValue.value = '';
            updateFilterCount();
            updateGraph();
        }
    });

    filterValue.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            addFilterBtn.click();
        }
    });

    clearFiltersBtn.addEventListener('click', function() {
        activeFilters.length = 0;
        updateFilterTags();
        updateFilterCount();
        updateGraph();
    });

    function updateFilterTags() {
        filterTree(obj, activeFilters)
        activeFilterTags.innerHTML = '';
        activeFilters.forEach((filter, index) => {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.innerHTML = `
                ${filter.type}: ${filter.value}
                <span class="filter-tag-close" data-index="${index}">×</span>
            `;
            activeFilterTags.appendChild(tag);
        });

        document.querySelectorAll('.filter-tag-close').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                activeFilters.splice(index, 1);
                updateFilterTags();
                updateFilterCount();
                updateGraph();
            });
        });
    }

    function updateFilterCount() {
        filterCount.textContent = activeFilters.length;
    }

    initGraphviz();
</script>
</body>
</html>
